<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تتبع موبايلك</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
            direction: rtl;
            text-align: right;
        }
        .container {
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 { color: #333; }
        form { display: flex; flex-direction: column; }
        input, button {
            margin: 10px 0;
            padding: 10px;
            font-size: 16px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover { background-color: #0056b3; }
        #message { color: red; margin-top: 10px; }
        #map { height: 400px; margin: 20px 0; }
        .section { display: none; }
        .section.active { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <!-- الصفحة الرئيسية -->
        <div id="home" class="section active">
            <h1>تتبع موبايلك بأمان</h1>
            <p>الخدمة للتتبع الذاتي فقط. لا تسمح لأحد بالوصول إلا بموافقتك.</p>
            <form id="phoneForm">
                <label for="phone">اكتب رقم موبايلك (مصر):</label>
                <input type="tel" id="phone" placeholder="مثال: 01012345678" required>
                <button type="submit">ابدأ تتبع موبايلك</button>
                <button type="button" id="testButton">اختبار بدون SMS (رمز: 123456)</button>
            </form>
            <div id="homeMessage"></div>
        </div>

        <!-- صفحة التحقق -->
        <div id="verify" class="section">
            <h1>تحقق من الرمز</h1>
            <p>بعتنالَك كود على رقمك — اكتبه هنا</p>
            <form id="otpForm">
                <label for="otp">رمز التحقق (OTP):</label>
                <input type="text" id="otp" placeholder="أدخل الرمز" required>
                <button type="submit">تحقق</button>
            </form>
            <div id="verifyMessage"></div>
        </div>

        <!-- صفحة الخريطة -->
        <div id="mapSection" class="section">
            <h1>موقع جهازك على الخريطة</h1>
            <p id="status">التتبع شغال — آخر تحديث: {وقت}</p>
            <div id="map"></div>
            <button id="startLive">تفعيل Live</button>
            <button id="stopShare">أوقف المشاركة</button>
            <p>نحترم خصوصيتك — الموقع بيشارك موقعك بس بعد موافقتك وبعد التحقق من رقمك. بيانات الموقع متخزّنة مؤقتًا ومشفّرة. تقدر توقف المشاركة أو تمسح السجل في أي وقت.</p>
        </div>
    </div>

    <script>
        // JavaScript للتنقل والتفاعل مع الباك اند
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
        }

        // زر الاختبار بدون SMS
        document.getElementById('testButton').addEventListener('click', function() {
            const phone = document.getElementById('phone').value.trim();
            if (!phone) {
                document.getElementById('homeMessage').textContent = 'اكتب رقمك أولًا';
                return;
            }
            localStorage.setItem('phone', phone);
            document.getElementById('homeMessage').textContent = 'اختبار: استخدم رمز 123456';
            showSection('verify');
        });

        // إرسال OTP (حقيقي عبر الباك اند، مع إضافة كود الدولة تلقائيًا)
        document.getElementById('phoneForm').addEventListener('submit', function(e) {
            e.preventDefault();
            let phone = document.getElementById('phone').value.trim();
            
            // إضافة كود الدولة إذا مش موجود
            if (!phone.startsWith('+')) {
                if (phone.startsWith('00')) {
                    phone = '+' + phone.slice(2);
                } else {
                    phone = '+20' + phone;
                }
            }
            
            localStorage.setItem('phone', phone);
            fetch('http://localhost:3000/send-otp', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ phone })
            })
            .then(res => {
                if (!res.ok) throw new Error('خطأ في الخادم: ' + res.status);
                return res.json();
            })
            .then(data => {
                if (data.message) {
                    document.getElementById('homeMessage').textContent = data.message;
                    showSection('verify');
                } else {
                    document.getElementById('homeMessage').textContent = data.error;
                }
            })
            .catch(err => {
                document.getElementById('homeMessage').textContent = 'خطأ في الاتصال: ' + err.message + '. تأكد إن الخادم شغّال على localhost:3000.';
            });
        });

        // التحقق من OTP (حقيقي أو ثابت للاختبار)
        document.getElementById('otpForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const phone = localStorage.getItem('phone');
            const otp = document.getElementById('otp').value;
            
            // إذا كان رقم الاختبار، تحقق محليًا
            if (otp === '123456' && !phone.startsWith('+20')) {
                document.getElementById('verifyMessage').textContent = 'تم التحقق (اختبار)';
                showSection('mapSection');
                return;
            }
            
            fetch('http://localhost:3000/verify-otp', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ phone, otp })
            })
            .then(res => {
                if (!res.ok) throw new Error('خطأ في الخادم: ' + res.status);
                return res.json();
            })
            .then(data => {
                if (data.message) {
                    document.getElementById('verifyMessage').textContent = data.message;
                    showSection('mapSection');
                } else {
                    document.getElementById('verifyMessage').textContent = data.error;
                }
            })
            .catch(err => {
                document.getElementById('verifyMessage').textContent = 'خطأ في الاتصال: ' + err.message + '. جرب الاختبار بدون SMS.';
            });
        });

        // الخريطة
        let map, marker, watchId;
        document.addEventListener('DOMContentLoaded', function() {
            map = L.map('map').setView([30.0444, 31.2357], 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
        });

        document.getElementById('startLive').addEventListener('click', function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    if (marker) map.removeLayer(marker);
                    marker = L.marker([lat, lng]).addTo(map).bindPopup('موقعك الحالي').openPopup();
                    map.setView([lat, lng], 15);
                    console.log('إحداثيات:', lat, lng);
                }, function(error) {
                    alert('خطأ في الحصول على الموقع: ' + error.message);
                });

                watchId = navigator.geolocation.watchPosition(function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    if (marker) map.removeLayer(marker);
                    marker = L.marker([lat, lng]).addTo(map);
                }, null, { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 });
            } else {
                alert('المتصفح مش يدعم مشاركة الموقع.');
            }
        });

        document.getElementById('stopShare').addEventListener('click', function() {
            if (watchId) navigator.geolocation.clearWatch(watchId);
            if (marker) map.removeLayer(marker);
            alert('تم إيقاف المشاركة.');
        });
    </script>
</body>
</html>
